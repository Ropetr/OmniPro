<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>OmniPro Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #fff;
      color: #1f2937;
    }
    .header {
      padding: 16px 20px;
      color: white;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    .header-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .header-info h3 { font-size: 15px; font-weight: 600; }
    .header-info p { font-size: 12px; opacity: 0.85; }
    .header-close {
      margin-left: auto; cursor: pointer; opacity: 0.8;
      background: none; border: none; color: white; font-size: 20px;
    }
    .header-close:hover { opacity: 1; }

    /* Pre-chat form */
    .prechat {
      flex: 1; padding: 24px 20px; display: flex; flex-direction: column;
      justify-content: center; gap: 16px;
    }
    .prechat h3 { font-size: 18px; font-weight: 600; }
    .prechat p { font-size: 13px; color: #6b7280; }
    .prechat input {
      padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 8px;
      font-size: 14px; outline: none; transition: border-color 0.2s;
    }
    .prechat input:focus { border-color: var(--primary-color); }
    .prechat button {
      padding: 12px; border: none; border-radius: 8px;
      color: white; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: opacity 0.2s;
    }
    .prechat button:hover { opacity: 0.9; }

    /* Chat area */
    .chat-container { display: none; flex: 1; flex-direction: column; }
    .messages {
      flex: 1; overflow-y: auto; padding: 16px 20px;
      display: flex; flex-direction: column; gap: 8px;
    }
    .message {
      max-width: 85%; padding: 10px 14px; border-radius: 12px;
      font-size: 14px; line-height: 1.4; word-wrap: break-word;
    }
    .message.received {
      align-self: flex-start; background: #f3f4f6; color: #1f2937;
      border-bottom-left-radius: 4px;
    }
    .message.sent {
      align-self: flex-end; color: white;
      border-bottom-right-radius: 4px;
    }
    .message .time {
      font-size: 11px; opacity: 0.6; margin-top: 4px; display: block;
    }
    .typing-indicator {
      display: none; align-self: flex-start;
      padding: 10px 14px; background: #f3f4f6; border-radius: 12px;
      font-size: 13px; color: #9ca3af;
    }

    /* Input area */
    .input-area {
      padding: 12px 16px; border-top: 1px solid #e5e7eb;
      display: flex; gap: 8px; align-items: center; flex-shrink: 0;
    }
    .input-area input {
      flex: 1; padding: 10px 14px; border: 1px solid #d1d5db;
      border-radius: 20px; font-size: 14px; outline: none;
    }
    .input-area input:focus { border-color: var(--primary-color); }
    .input-area button {
      width: 36px; height: 36px; border: none; border-radius: 50%;
      color: white; cursor: pointer; display: flex;
      align-items: center; justify-content: center; flex-shrink: 0;
    }
    .input-area button:disabled { opacity: 0.5; cursor: not-allowed; }

    .powered-by {
      text-align: center; padding: 6px; font-size: 11px; color: #9ca3af;
    }
    .powered-by a { color: #6b7280; text-decoration: none; }
  </style>
</head>
<body>
  <div class="header" id="header">
    <div class="header-avatar">ðŸ’¬</div>
    <div class="header-info">
      <h3>Suporte</h3>
      <p id="header-status">Online</p>
    </div>
    <button class="header-close" onclick="closeWidget()" title="Fechar">&times;</button>
  </div>

  <!-- Pre-chat form -->
  <div class="prechat" id="prechat">
    <h3>OlÃ¡! ðŸ‘‹</h3>
    <p>Preencha seus dados para iniciar o atendimento</p>
    <input type="text" id="visitor-name" placeholder="Seu nome" required>
    <input type="email" id="visitor-email" placeholder="Seu email (opcional)">
    <button id="start-chat-btn" onclick="startChat()">Iniciar conversa</button>
  </div>

  <!-- Chat area -->
  <div class="chat-container" id="chat-container">
    <div class="messages" id="messages">
      <div class="typing-indicator" id="typing">Digitando...</div>
    </div>
    <div class="input-area">
      <input type="text" id="message-input" placeholder="Digite sua mensagem..." onkeypress="handleKeyPress(event)">
      <button id="send-btn" onclick="sendMessage()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="white"/>
        </svg>
      </button>
    </div>
    <div class="powered-by">Powered by <a href="#">OmniPro</a></div>
  </div>

  <script>
    // Parse URL params
    var params = new URLSearchParams(window.location.search);
    var channelId = params.get('channelId') || '';
    var apiUrl = params.get('apiUrl') || 'http://localhost:3001';
    var primaryColor = decodeURIComponent(params.get('color') || '#4F46E5');

    // Apply color
    document.documentElement.style.setProperty('--primary-color', primaryColor);
    document.getElementById('header').style.background = primaryColor;
    document.getElementById('start-chat-btn').style.background = primaryColor;
    document.getElementById('send-btn').style.background = primaryColor;

    var visitorId = localStorage.getItem('omnipro_visitor_id') || 'v_' + Math.random().toString(36).substr(2, 12);
    localStorage.setItem('omnipro_visitor_id', visitorId);
    var conversationId = null;
    var visitorName = '';
    var visitorEmail = '';

    // Socket connection
    var socket = null;

    function connectSocket() {
      if (typeof io === 'undefined') {
        // Load Socket.IO client
        var script = document.createElement('script');
        script.src = apiUrl.replace('/api', '') + '/socket.io/socket.io.js';
        script.onload = function() { initSocket(); };
        document.head.appendChild(script);
      } else {
        initSocket();
      }
    }

    function initSocket() {
      socket = io(apiUrl.replace('/api', '') + '/visitors', {
        auth: { visitorId: visitorId, tenantId: channelId },
      });

      socket.on('connect', function() {
        console.log('OmniPro: Connected');
      });

      socket.on('new_message', function(msg) {
        if (msg.sender !== 'contact') {
          addMessage(msg.content, 'received', msg.createdAt);
          window.parent.postMessage({ type: 'omnipro-new-message' }, '*');
        }
      });

      socket.on('agent_typing', function() {
        showTyping();
      });
    }

    function startChat() {
      visitorName = document.getElementById('visitor-name').value.trim();
      visitorEmail = document.getElementById('visitor-email').value.trim();

      if (!visitorName) {
        document.getElementById('visitor-name').style.borderColor = '#ef4444';
        return;
      }

      document.getElementById('prechat').style.display = 'none';
      document.getElementById('chat-container').style.display = 'flex';

      // Send welcome message
      addMessage('OlÃ¡ ' + visitorName + '! Como podemos ajudar?', 'received');

      connectSocket();
    }

    function sendMessage() {
      var input = document.getElementById('message-input');
      var text = input.value.trim();
      if (!text) return;

      addMessage(text, 'sent');
      input.value = '';

      // Send via API
      fetch(apiUrl + '/api/webhooks/webchat/' + channelId, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          visitorId: visitorId,
          visitorName: visitorName,
          visitorEmail: visitorEmail,
          message: text,
        }),
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        if (data.conversationId) conversationId = data.conversationId;
        if (data.botReply) {
          setTimeout(function() {
            addMessage(data.botReply, 'received');
          }, 500);
        }
      })
      .catch(function(err) {
        console.error('Send failed:', err);
      });

      // Emit via socket
      if (socket) {
        socket.emit('send_message', {
          conversationId: conversationId,
          content: text,
          visitorId: visitorId,
        });
      }
    }

    function addMessage(text, type, timestamp) {
      var messagesEl = document.getElementById('messages');
      var typingEl = document.getElementById('typing');
      var div = document.createElement('div');
      div.className = 'message ' + type;
      if (type === 'sent') {
        div.style.background = primaryColor;
      }
      var time = timestamp ? new Date(timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
        : new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      div.innerHTML = text + '<span class="time">' + time + '</span>';
      messagesEl.insertBefore(div, typingEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function showTyping() {
      var el = document.getElementById('typing');
      el.style.display = 'block';
      setTimeout(function() { el.style.display = 'none'; }, 3000);
    }

    function handleKeyPress(e) {
      if (e.key === 'Enter') sendMessage();
      if (socket) socket.emit('typing');
    }

    function closeWidget() {
      window.parent.postMessage({ type: 'omnipro-close' }, '*');
    }

    // Check for returning visitor
    var savedName = localStorage.getItem('omnipro_visitor_name');
    if (savedName) {
      document.getElementById('visitor-name').value = savedName;
    }
  </script>
</body>
</html>
